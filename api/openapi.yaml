#   Copyright 2019 A2OS SafeU Dev Team
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

openapi: 3.0.0
info:
  title: A2OS SafeU
  description: |
    A2OS SafeU 项目 API 文档。
  contact:
    email: a2os-general@googlegroups.com
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: "1.0.0-alpha"
externalDocs:
  description: Find out more about A2OS SafeU backend
  url: https://api.safeu.a2os.club
tags:
  - name: upload
    description: Upload item(s) operations
  - name: update
    description: Update item(s) operations
  - name: download
    description: Download item(s) operations
  - name: validation
    description: Validation operations
paths:
  /v1/downCount/{retrieveCode}:
    get:
      tags:
        - download
      summary: 下载感知接口
      operationId: downloadAwareness
      parameters:
        - name: retrieveCode
          in: path
          description: 提取码
          required: true
          schema:
            type: string
        - name: bucket
          in: query
          description: 文件所在 OSS 桶名
          required: true
          schema:
            type: string
        - name: path
          in: query
          description: 文件所在 OSS 桶中的绝对路径
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功接收下载信息
          content:
            'text/plain':
              schema:
                type: string
                description: 数据操作（OK，MINUS，DELETED）
        '404':
          description: 无法找到资源
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '500':
          description: 服务器错误
          content:
            'text/plain':
              schema:
                type: string
                description: 未知错误

  /v1/item/{retrieveCode}:
    post:
      tags:
        - download
      summary: 获取下载/打包文件连接
      operationId: downloadItem
      parameters:
        - name: Token
          in: header
          description: 临时认证口令
          style: simple
          required: true
          schema:
            type: string
        - name: retrieveCode
          in: path
          description: 提取码
          required: true
          schema:
            type: string
      requestBody:
        content:
          'application/json':
            schema:
              $ref: '#/components/schemas/PackRequest'
      responses:
        '200':
          description: 成功获取文件（组）下载链接
          content:
            'application/json':
              schema:
                type: object
                properties:
                  url:
                    type: string
                    description: 文件（组）下载链接
        '400':
          description: 无法获得文件列表
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '401':
          description: 认证失败
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '404':
          description: 无法找到资源/认证口令
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '410':
          description: 下载次数耗尽
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '503':
          description: 无法提供服务
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因

  /v1/validation/{retrieveCode}:
    post:
      tags:
        - validation
      summary: 提取码认证接口
      operationId: validateRC
      parameters:
        - name: retrieveCode
          in: path
          description: 提取码
          required: true
          schema:
            type: string
      requestBody:
        content:
         'application/json':
            schema:
              type: object
              properties:
                password:
                  type: string
                  description: 文件提取密码
      responses:
        '200':
          description: 认证成功
          content:
            'application/json':
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: 临时认证口令
                  items:
                    $ref: '#/components/schemas/ItemGroup'
        '401':
          description: 需要密码 / 密码认证失败
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '404':
          description: 无法通过该提取码找到文件
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因
        '500':
          description: 资源不可用
          content:
            'application/json':
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: 错误原因

components:
  schemas:
    Item:
      type: object
      description: 文件
      properties:
        id:
          type: integer
          format: int64
        status:
          type: integer
          format: int32
          description: 文件状态（正常，异常，已删除）
        name:
          type: string
          description: 存储单位 UUID 值
        original_name:
          type: string
          description: 文件原名
        host:
          type: string
          description: 存储后端的 bucket 记录
        re_code:
          type: string
          description: 提取码
        password:
          type: string
          description: 私有文件[组]的密码
        down_count:
          type: integer
          format: int32
          description: 可下载次数
        type:
          type: string
          description: 文件类型
        is_public:
          type: boolean
          description: 是否公有
        archive_type:
          type: integer
          format: int32
          description: 压缩包类型（NULL，FULL，CUSTOM）
        protocol:
          type: string
          description: OSS 下载协议
        bucket:
          type: string
          description: 文件所在 OSS 桶名
        endpoint:
          type: string
          description: OSS 地域路径
        path:
          type: string
          description: 文件所在 OSS 桶中的绝对路径
        created_at:
          type: string
          format: date-time
          description: 最初生成时间
        updated_at:
          type: string
          format: date-time
          description: 最后更新时间
        deleted_at:
          type: string
          format: date-time
          description: 记录删除时间
    ItemGroup:
      type: array
      items:
        $ref: '#/components/schemas/Item'
      description: 文件组
    ZipItem:
      type: object
      description: 待下载文件
      properties:
        protocol:
          type: string
          description: OSS 下载协议
        bucket:
          type: string
          description: 文件所在 OSS 桶名
        endpoint:
          type: string
          description: OSS 地域路径
        path:
          type: string
          description: 文件所在 OSS 桶中的绝对路径
        original_name:
          type: string
          description: 文件原名
    PackRequest:
      type: object
      description: 打包/下载链接请求
      properties:
        full:
          type: boolean
          description: 是否为该提取码下的全部文件
        items:
          type: array
          description: 待打包/下载文件
          items:
            $ref: '#/components/schemas/ZipItem'
          
